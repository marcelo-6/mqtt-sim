name: Publish Package

on:
  workflow_call:
    inputs:
      use_testpypi:
        description: "Publish to TestPyPI instead of PyPI."
        required: false
        default: true
        type: boolean
  workflow_dispatch:
    inputs:
      use_testpypi:
        description: "Publish to TestPyPI instead of PyPI."
        required: true
        default: true
        type: boolean

concurrency:
  group: publish-package-${{ github.ref_name || github.run_id }}
  cancel-in-progress: false

permissions:
  contents: read

jobs:
  publish:
    name: Build and publish package
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (full history + tags)
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Install just
        uses: taiki-e/install-action@just

      - name: Sync dependencies (including dev)
        run: just install

      - name: Select publish target
        id: target
        shell: bash
        run: |
          if [[ "${{ inputs.use_testpypi }}" == "true" ]]; then
            echo "name=testpypi" >> "$GITHUB_OUTPUT"
          else
            echo "name=pypi" >> "$GITHUB_OUTPUT"
          fi

      - name: Build package artifacts (tag/release build)
        if: startsWith(github.ref, 'refs/tags/v')
        run: just package

      - name: Build package artifacts (dev/test build)
        if: ${{ !startsWith(github.ref, 'refs/tags/v') }}
        run: just package-dev

      - name: Publish to TestPyPI
        if: steps.target.outputs.name == 'testpypi'
        env:
          UV_PUBLISH_TOKEN: ${{ secrets.TEST_PYPI_API_TOKEN }}
        run: |
          if [[ -z "${UV_PUBLISH_TOKEN:-}" ]]; then
            echo "Missing TEST_PYPI_API_TOKEN secret."
            exit 1
          fi
          uv publish \
            --publish-url https://test.pypi.org/legacy/ \
            --check-url https://test.pypi.org/simple/

      - name: Publish to PyPI
        if: steps.target.outputs.name == 'pypi'
        env:
          UV_PUBLISH_TOKEN: ${{ secrets.PYPI_API_TOKEN }}
        run: |
          if [[ -z "${UV_PUBLISH_TOKEN:-}" ]]; then
            echo "Missing PYPI_API_TOKEN secret."
            exit 1
          fi
          if [[ ! "${GITHUB_REF}" =~ ^refs/tags/v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "PyPI publishing is only allowed from vX.Y.Z tags."
            exit 1
          fi
          uv publish
